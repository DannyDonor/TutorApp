{% extends "base.html" %}

{% block title %}–°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫ - {{ module.title }} - TutorApp{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>‚ûï –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫</h2>
        <div class="breadcrumb">
            <a href="{{ url_for('course_detail', course_id=course.id) }}">{{ course.title }}</a>
            ‚Üí
            <span>{{ module.title }}</span>
            ‚Üí
            <span>–ù–æ–≤—ã–π —É—Ä–æ–∫</span>
        </div>
    </div>
    
    <form method="POST" class="auth-form">
        <div class="form-group">
            <label for="title">üìñ –ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞ *</label>
            <input type="text" id="title" name="title" required
                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–≤–µ–¥–µ–Ω–∏–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ"
                   maxlength="200">
            <small class="form-text">–ö—Ä–∞—Ç–∫–æ–µ –∏ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞</small>
        </div>
        
        <div class="form-group">
            <label for="content">üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—Ä–æ–∫–∞</label>
            <textarea id="content" name="content" rows="12"
                      placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—Ä–æ–∫–∞. –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é —Ä–∞–∑–º–µ—Ç–∫—É:

**–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç**
*–ö—É—Ä—Å–∏–≤*

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ 1
## –ó–∞–≥–æ–ª–æ–≤–æ–∫ 2

- –°–ø–∏—Å–æ–∫
- —ç–ª–µ–º–µ–Ω—Ç–æ–≤

1. –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π
2. —Å–ø–∏—Å–æ–∫

–ö–æ–¥: `–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è = –∑–Ω–∞—á–µ–Ω–∏–µ`

–ë–ª–æ–∫ –∫–æ–¥–∞:
```
print('–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!')
```

–°—Å—ã–ª–∫–∞: [—Ç–µ–∫—Å—Ç](–∞–¥—Ä–µ—Å)"></textarea>
            <small class="form-text">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏</small>
        </div>
        
        <div class="info-box">
            <h4>üí° –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —É—Ä–æ–∫–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ:</h4>
            <ul>
                <li>üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –¥–æ–∫—É–º–µ–Ω—Ç—ã)</li>
                <li>üìù –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</li>
                <li>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—Ä–æ–∫–∞</li>
                <li>üë• –£–≤–∏–¥–µ—Ç—å, –∫—Ç–æ –∏–∑—É—á–∏–ª —É—Ä–æ–∫</li>
            </ul>
        </div>
        
        <div class="preview-box" style="display: none;">
            <h4>üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä:</h4>
            <div id="content-preview"></div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                ‚úÖ –°–æ–∑–¥–∞—Ç—å —É—Ä–æ–∫
            </button>
            <button type="button" class="btn btn-secondary" onclick="togglePreview()">
                üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            </button>
            <a href="{{ url_for('course_detail', course_id=course.id) }}" class="btn btn-outline">
                ‚ùå –û—Ç–º–µ–Ω–∞
            </a>
        </div>
    </form>
</div>

<style>
.breadcrumb {
    font-size: 0.9em;
    color: #666;
    margin-top: 0.5rem;
}

.breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.info-box {
    background: linear-gradient(135deg, #f8f9ff, #e8f2ff);
    border: 1px solid #c3d9ff;
    border-radius: var(--radius);
    padding: 1.5rem;
    margin: 2rem 0;
}

.info-box h4 {
    margin: 0 0 1rem 0;
    color: var(--primary-color);
}

.info-box ul {
    margin: 0;
    padding-left: 1.5rem;
}

.info-box li {
    margin-bottom: 0.5rem;
    line-height: 1.4;
}

.preview-box {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: var(--radius);
    padding: 1.5rem;
    margin: 2rem 0;
}

.preview-box h4 {
    margin: 0 0 1rem 0;
    color: #333;
}

#content-preview {
    background: white;
    padding: 1rem;
    border-radius: var(--radius-sm);
    min-height: 100px;
    line-height: 1.6;
}

#content-preview h1, #content-preview h2, #content-preview h3 {
    color: var(--primary-color);
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
}

#content-preview h1:first-child, 
#content-preview h2:first-child, 
#content-preview h3:first-child {
    margin-top: 0;
}

#content-preview code {
    background: #f1f3f4;
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

#content-preview pre {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: var(--radius-sm);
    overflow-x: auto;
    margin: 1rem 0;
}

#content-preview pre code {
    background: none;
    padding: 0;
}

#content-preview ul, #content-preview ol {
    margin: 1rem 0;
    padding-left: 2rem;
}

#content-preview li {
    margin-bottom: 0.5rem;
}

#content-preview a {
    color: var(--primary-color);
}

.form-group textarea {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    line-height: 1.5;
}

.card-header h2 {
    margin: 0;
}
</style>

<script>
function togglePreview() {
    const content = document.getElementById('content').value;
    const previewBox = document.querySelector('.preview-box');
    const previewDiv = document.getElementById('content-preview');
    
    if (previewBox.style.display === 'none') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        previewDiv.innerHTML = formatContent(content);
        previewBox.style.display = 'block';
        previewBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        previewBox.style.display = 'none';
    }
}

function formatContent(text) {
    if (!text.trim()) {
        return '<p class="text-muted">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –∑–¥–µ—Å—å...</p>';
    }
    
    // –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Markdown-–ø–æ–¥–æ–±–Ω–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
    let html = text
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        // –ñ–∏—Ä–Ω—ã–π –∏ –∫—É—Ä—Å–∏–≤
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // –ö–æ–¥
        .replace(/`([^`]*)`/g, '<code>$1</code>')
        // –°—Å—ã–ª–∫–∏
        .replace(/\[([^\]]*)\]\(([^)]*)\)/g, '<a href="$2" target="_blank">$1</a>')
        // –ü–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
    
    // –ë–ª–æ–∫–∏ –∫–æ–¥–∞
    html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    
    // –°–ø–∏—Å–∫–∏
    html = html.replace(/^\s*[-*+]\s+(.*$)/gim, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    
    html = html.replace(/^\s*\d+\.\s+(.*$)/gim, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
    
    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
    if (!html.startsWith('<')) {
        html = '<p>' + html + '</p>';
    }
    
    return html;
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
document.addEventListener('DOMContentLoaded', function() {
    const titleInput = document.getElementById('title');
    const contentTextarea = document.getElementById('content');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const savedTitle = localStorage.getItem('lesson_title');
    const savedContent = localStorage.getItem('lesson_content');
    
    if (savedTitle) titleInput.value = savedTitle;
    if (savedContent) contentTextarea.value = savedContent;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    titleInput.addEventListener('input', function() {
        localStorage.setItem('lesson_title', this.value);
    });
    
    contentTextarea.addEventListener('input', function() {
        localStorage.setItem('lesson_content', this.value);
    });
    
    // –û—á–∏—â–∞–µ–º –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.querySelector('form').addEventListener('submit', function() {
        localStorage.removeItem('lesson_title');
        localStorage.removeItem('lesson_content');
    });
});
</script>
{% endblock %}