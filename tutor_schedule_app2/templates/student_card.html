{% extends "base.html" %}

{% block title %}{{ student.full_name }} - TutorApp{% endblock %}

{% block content %}
<div class="student-profile-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="profile-header">
        <div class="profile-title">
            <h1>üë§ {{ student.full_name }}</h1>
            <div class="profile-stats">
                <span class="stat-item">üìö {{ student.lessons_count }} –∑–∞–Ω—è—Ç–∏–π</span>
                <span class="stat-item">üì± {{ student.telegram_chat_id or 'ID –Ω–µ —É–∫–∞–∑–∞–Ω' }}</span>
            </div>
        </div>
        <div class="profile-actions">
            <a href="{{ url_for('all_students') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="profile-content">
        <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
        <div class="sidebar">
            <nav class="sidebar-nav">
                <a href="#info" class="nav-item active" onclick="showSection('info', this)">
                    üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                </a>
                <a href="#lessons" class="nav-item" onclick="showSection('lessons', this)">
                    üìö –ó–∞–Ω—è—Ç–∏—è
                </a>
                <a href="#homework" class="nav-item" onclick="showSection('homework', this)">
                    üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
                </a>
                <a href="#payments" class="nav-item" onclick="showSection('payments', this)">
                    üí∞ –ü–ª–∞—Ç–µ–∂–∏
                </a>
                <a href="#parents" class="nav-item" onclick="showSection('parents', this)">
                    üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –†–æ–¥–∏—Ç–µ–ª–∏
                </a>
            </nav>
            
            <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
            <div class="quick-actions">
                <h4>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
                <a href="{{ url_for('add_payment', student_id=student.id) }}" class="action-btn">
                    üí∞ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂
                </a>
                <a href="{{ url_for('students_homeworks', student_id=student.id) }}" class="action-btn">
                    üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –î–ó
                </a>
                <a href="{{ url_for('add_lesson') }}" class="action-btn">
                    üìÖ –ù–æ–≤—ã–π —É—Ä–æ–∫
                </a>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="main-content">
            <!-- –°–µ–∫—Ü–∏—è: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div id="info-section" class="content-section active">
                <div class="section-grid">
                    <div class="info-card">
                        <h3>üìö –ë–∞–ª–∞–Ω—Å –∑–∞–Ω—è—Ç–∏–π</h3>
                        <div class="balance-display">
                            <span id="lessonsCountDisplay" class="balance-number">{{ student.lessons_count }}</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleLessonsEdit()">
                                ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                        <div id="editLessonsCountForm" class="edit-form" style="display: none;">
                            <form action="{{ url_for('edit_student_lessons_count', student_id=student.id) }}" method="POST">
                                <div class="input-group">
                                    <input type="number" name="lessons_count" value="{{ student.lessons_count }}" required>
                                    <button type="submit" class="btn btn-primary">üíæ</button>
                                    <button type="button" class="btn btn-secondary" onclick="toggleLessonsEdit()">‚ùå</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                        <div class="notification-status">
                            {% if student.receive_notifications %}
                                <span class="status-badge status-on">‚úÖ –í–∫–ª—é—á–µ–Ω—ã</span>
                            {% else %}
                                <span class="status-badge status-off">‚ùå –û—Ç–∫–ª—é—á–µ–Ω—ã</span>
                            {% endif %}
                            <form action="{{ url_for('toggle_student_notifications', student_id=student.id) }}" method="POST">
                                <button type="submit" class="btn btn-sm {% if student.receive_notifications %}btn-warning{% else %}btn-success{% endif %}">
                                    {% if student.receive_notifications %}üîï{% else %}üîî{% endif %}
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3>üë§ –ê–∫–∫–∞—É–Ω—Ç</h3>
                        {% if student.user_account %}
                            <div class="account-info">
                                <div class="account-details">
                                    <span class="status-badge status-on">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                                    <div class="account-data">
                                        <strong>Email:</strong> {{ student.user_account.email }}<br>
                                        <strong>–õ–æ–≥–∏–Ω:</strong> {{ student.user_account.username }}
                                    </div>
                                </div>
                </div>
                                    {% else %}
                            <div class="account-info">
                                <span class="status-badge status-pending">‚è≥ –ù–µ —Å–æ–∑–¥–∞–Ω</span>
                                <p><small>–ê–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞</small></p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –ó–∞–Ω—è—Ç–∏—è -->
            <div id="lessons-section" class="content-section">
                <div class="section-header">
                    <h2>üìö –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–Ω—è—Ç–∏—è</h2>
                    <span class="section-count">{{ lessons|length }} –≤—Å–µ–≥–æ</span>
                </div>
                
                {% if lessons %}
                    <div class="lessons-grid">
                        {% for lesson in lessons[:6] %}
                            <div class="lesson-card">
                                <div class="lesson-date">{{ lesson.date_time.strftime('%d.%m.%Y') }}</div>
                                <div class="lesson-time">{{ lesson.date_time.strftime('%H:%M') }}</div>
                                <div class="lesson-status status-{{ lesson.status }}">
                                    {% if lesson.status == '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω' %}üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω
                                    {% elif lesson.status == '–ø—Ä–æ–≤–µ–¥–µ–Ω' %}‚úÖ –ü—Ä–æ–≤–µ–¥–µ–Ω
                                    {% elif lesson.status == '–æ—Ç–º–µ–Ω–µ–Ω' %}‚ùå –û—Ç–º–µ–Ω–µ–Ω
                                    {% elif lesson.status == '–Ω–µ_–ø—Ä–∏—à–µ–ª' %}üëª –ù–µ –ø—Ä–∏—à–µ–ª
                                    {% endif %}
                                </div>
                                {% if lesson.topic_covered %}
                                    <div class="lesson-topic">{{ lesson.topic_covered }}</div>
                                {% endif %}
                                {% if lesson.status == '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω' %}
                                    <a href="{{ url_for('edit_lesson', lesson_id=lesson.id) }}" class="lesson-action">‚úèÔ∏è</a>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    {% if lessons|length > 6 %}
                        <div class="show-more">
                            <small>–ü–æ–∫–∞–∑–∞–Ω–æ 6 –∏–∑ {{ lessons|length }} –∑–∞–Ω—è—Ç–∏–π</small>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üìö</div>
                        <p>–ó–∞–Ω—è—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    </div>
                {% endif %}
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è -->
            <div id="homework-section" class="content-section">
                <div class="section-header">
                    <h2>üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
                    <a href="{{ url_for('students_homeworks', student_id=student.id) }}" class="btn btn-primary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –î–ó</a>
                </div>
                
                {% if homeworks %}
                    <div class="homework-grid">
                        {% for hw in homeworks[:4] %}
                            <div class="homework-card">
                                <div class="homework-title">{{ hw.description }}</div>
                                <div class="homework-status">
                                    {% if hw.is_confirmed_by_tutor %}
                                        <span class="status-badge status-confirmed">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
                                    {% elif hw.submitted_date %}
                                        <span class="status-badge status-pending">‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
                                    {% elif hw.is_completed %}
                                        <span class="status-badge status-completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                                    {% else %}
                                        <span class="status-badge status-todo">üìã –ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</span>
                                    {% endif %}
                                </div>
                                {% if hw.due_date %}
                                    <div class="homework-date">–î–æ: {{ hw.due_date.strftime('%d.%m.%Y') }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <p>–î–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</p>
                    </div>
                {% endif %}
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –ü–ª–∞—Ç–µ–∂–∏ -->
            <div id="payments-section" class="content-section">
                <div class="section-header">
                    <h2>üí∞ –ü–ª–∞—Ç–µ–∂–∏</h2>
                    <a href="{{ url_for('add_payment', student_id=student.id) }}" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</a>
                </div>
                
                {% if payments %}
                    <div class="payments-list">
                        {% for payment in payments[:5] %}
                            <div class="payment-item">
                                <div class="payment-amount">{{ "%.2f"|format(payment.amount) }} ‚ÇΩ</div>
                                <div class="payment-details">
                                    <div class="payment-date">{{ payment.payment_date.strftime('%d.%m.%Y %H:%M') }}</div>
                                    <div class="payment-description">{{ payment.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</div>
                                </div>
                                <a href="{{ url_for('delete_payment', payment_id=payment.id) }}" 
                                   class="payment-delete" 
                                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂?')">üóëÔ∏è</a>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üí∞</div>
                        <p>–ü–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç</p>
                    </div>
                {% endif %}
            </div>

            <!-- –°–µ–∫—Ü–∏—è: –†–æ–¥–∏—Ç–µ–ª–∏ -->
            <div id="parents-section" class="content-section">
                <div class="section-header">
                    <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –†–æ–¥–∏—Ç–µ–ª–∏</h2>
                    <a href="{{ url_for('add_parent', student_id=student.id) }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è</a>
                </div>
                
                {% if parents %}
                    <div class="parents-list">
                        {% for parent in parents %}
                            <div class="parent-item">
                                <div class="parent-info">
                                    <span class="parent-id">üì± {{ parent.telegram_chat_id }}</span>
                                </div>
                                <a href="{{ url_for('delete_parent', student_id=student.id, parent_id=parent.id) }}" 
                                   class="parent-delete" 
                                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è?')">üóëÔ∏è</a>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                        <p>–†–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.student-profile-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
}

.profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1.5rem 2rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    margin-bottom: 1.5rem;
}

.profile-title h1 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
    font-size: 1.8rem;
}

.profile-stats {
    display: flex;
    gap: 1rem;
}

.stat-item {
    background: var(--secondary-color);
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.profile-content {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 1.5rem;
    min-height: 600px;
}

.sidebar {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: 1.5rem;
    height: fit-content;
    position: sticky;
    top: 1rem;
}

.sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 2rem;
}

.nav-item {
    display: block;
    padding: 0.75rem 1rem;
    text-decoration: none;
    color: var(--text-secondary);
    border-radius: var(--radius-sm);
    transition: all 0.2s;
    cursor: pointer;
}

.nav-item:hover, .nav-item.active {
    background: var(--primary-color);
    color: white;
    text-decoration: none;
}

.quick-actions h4 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
    font-size: 1rem;
}

.action-btn {
    display: block;
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.5rem;
    background: var(--secondary-color);
    color: var(--text-primary);
    text-decoration: none;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    transition: all 0.2s;
}

.action-btn:hover {
    background: var(--primary-color);
    color: white;
    text-decoration: none;
}

.main-content {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: 2rem;
}

.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.section-header h2 {
    margin: 0;
    color: var(--text-primary);
}

.section-count {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.section-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.info-card {
    background: var(--secondary-color);
    padding: 1.5rem;
    border-radius: var(--radius-md);
    border-left: 4px solid var(--primary-color);
}

.info-card h3 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
    font-size: 1.1rem;
}

.balance-display {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.balance-number {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
}

.notification-status, .account-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    font-weight: 500;
}

.status-on { background: #d1fae5; color: #065f46; }
.status-off { background: #fee2e2; color: #991b1b; }
.status-pending { background: #fef3c7; color: #92400e; }
.status-confirmed { background: #d1fae5; color: #065f46; }
.status-completed { background: #dbeafe; color: #1e40af; }
.status-todo { background: #f3f4f6; color: #374151; }

.lessons-grid, .homework-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}

.lesson-card, .homework-card {
    background: var(--secondary-color);
    padding: 1rem;
    border-radius: var(--radius-md);
    position: relative;
    border-left: 4px solid var(--accent-color);
}

.lesson-date {
    font-weight: bold;
    color: var(--text-primary);
}

.lesson-time {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.lesson-status {
    margin: 0.5rem 0;
    font-size: 0.85rem;
}

.lesson-topic {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

.lesson-action {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    text-decoration: none;
    padding: 0.25rem;
}

.homework-title {
    font-weight: bold;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.homework-date {
    color: var(--text-secondary);
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

.payments-list, .parents-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.payment-item, .parent-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--secondary-color);
    padding: 1rem;
    border-radius: var(--radius-md);
}

.payment-amount {
    font-weight: bold;
    color: var(--success-color);
    font-size: 1.1rem;
}

.payment-details {
    flex: 1;
    margin-left: 1rem;
}

.payment-date {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.payment-description {
    color: var(--text-primary);
    font-size: 0.95rem;
}

.payment-delete, .parent-delete {
    color: var(--danger-color);
    text-decoration: none;
    padding: 0.25rem;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.show-more {
    text-align: center;
    margin-top: 1rem;
    color: var(--text-secondary);
}

.edit-form {
    margin-top: 1rem;
}

.edit-form .input-group {
    display: flex;
    gap: 0.5rem;
}

.edit-form input {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
}

@media (max-width: 1024px) {
    .profile-content {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        position: static;
    }
    
    .sidebar-nav {
        flex-direction: row;
        overflow-x: auto;
        gap: 0.25rem;
    }
    
    .nav-item {
        white-space: nowrap;
        padding: 0.5rem 0.75rem;
    }
}

@media (max-width: 768px) {
    .profile-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .profile-stats {
        justify-content: center;
    }
    
    .section-grid {
        grid-template-columns: 1fr;
    }
    
    .lessons-grid, .homework-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function showSection(sectionId, navItem) {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –ø—É–Ω–∫—Ç–æ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
    document.getElementById(sectionId + '-section').classList.add('active');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø—É–Ω–∫—Ç—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    navItem.classList.add('active');
}

function toggleLessonsEdit() {
    const form = document.getElementById('editLessonsCountForm');
    const display = document.getElementById('lessonsCountDisplay');
    
    if (form.style.display === 'none') {
        form.style.display = 'block';
        display.style.display = 'none';
    } else {
        form.style.display = 'none';
        display.style.display = 'inline';
    }
}
</script>
{% endblock %}